<!DOCTYPE html> 
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Global Script Explorer | By Angga Conni Saputra</title>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-paper: #F4F1EC;
            --land: #E6DFD3;
            --water: #C7D7D9;
            --ink-primary: #2F2A24;
            --highlight: #8B5E3C;
            --gold: #D4AF37;
            --font-display: 'Cinzel', serif;
            --font-ui: 'Inter', sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background-color: var(--bg-paper); color: var(--ink-primary); font-family: var(--font-ui); overflow: hidden; }

        /* Landing Page */
        #landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #1a1816; color: #fff; transition: opacity 0.8s ease; }
        #landing-page.hidden { opacity: 0; pointer-events: none; }
        .landing-title { font-family: var(--font-display); font-size: 3rem; margin-bottom: 1rem; text-align: center; }
        .enter-btn { background: var(--gold); border: none; padding: 12px 30px; font-weight: bold; cursor: pointer; color: #1a1816; border-radius: 4px; }

        /* Map & UI */
        #map { height: 100%; width: 100%; z-index: 1; background: var(--water); }
        .header-float { position: absolute; top: 20px; left: 20px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px; width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status-lamp { width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; display: inline-block; margin-right: 5px; }
        .status-lamp.ready { background-color: #15803d; box-shadow: 0 0 5px #15803d; }
        .status-lamp.error { background-color: #991b1b; }
        
        /* Panel */
        .info-panel { position: absolute; top: 20px; right: 20px; bottom: 20px; width: 450px; background: white; z-index: 1001; transform: translateX(120%); transition: transform 0.4s ease; border-radius: 12px; box-shadow: -5px 0 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .info-panel.open { transform: translateX(0); }
        .panel-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { flex: 1; overflow-y: auto; padding: 20px; background: #fafafa; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* Script Card */
        .script-card { background: white; border: 1px solid #e5e5e5; border-radius: 8px; margin-bottom: 15px; padding: 20px; transition: 0.2s; }
        .script-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .script-name { font-weight: 700; font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .script-sample { font-size: 3rem; text-align: center; margin: 15px 0; color: #333; min-height: 60px; line-height: 1; }
        .meta-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 8px; text-align: center; border-radius: 4px; text-decoration: none; font-size: 0.8rem; font-weight: 600; cursor: pointer; border: 1px solid #ddd; }
        .btn-primary { background: var(--ink-primary); color: white; border: none; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .info-panel { width: 100%; top: auto; bottom: 0; height: 70vh; transform: translateY(100%); border-radius: 20px 20px 0 0; }
            .info-panel.open { transform: translateY(0); }
            .header-float { width: auto; right: 20px; }
        }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="landing-title">Global Script Explorer</div>
        <button class="enter-btn" onclick="enterApp()">Mulai Penjelajahan</button>
    </div>

    <div class="header-float">
        <div style="display:flex; align-items:center; margin-bottom:5px;">
            <div id="connStatus" class="status-lamp"></div>
            <strong>Status Data</strong>
        </div>
        <div id="statusArea" style="font-size:0.8rem; color:#666;">Menunggu Load...</div>
        <div style="font-size:0.7rem; margin-top:10px; border-top:1px solid #eee; padding-top:5px;">
            Klik negara untuk melihat aksara.
        </div>
    </div>

    <div id="map"></div>

    <div class="info-panel" id="infoPanel">
        <div class="panel-header">
            <div>
                <h2 id="countryName" style="margin:0;">Country</h2>
                <span id="countryCode" style="color:#666; font-family:monospace;">ISO</span>
            </div>
            <button class="close-btn" onclick="closePanel()">&times;</button>
        </div>
        <div class="panel-body" id="scriptList"></div>
    </div>

    <script>
        let GLOBAL_SCRIPT_DB = {};
        let loadedFonts = new Set();
        
        // --- 1. FIXED ISO MAPPING (PENTING!) ---
        // Peta GeoJSON sering menggunakan kode 3 huruf yang tidak standar konversinya.
        // Kita gunakan peta manual untuk negara-negara besar agar akurat.
        const ISO_MAP = {
            'IDN': 'ID', 'CHN': 'CN', 'USA': 'US', 'IND': 'IN', 'JPN': 'JP', 
            'LKA': 'LK', 'MNG': 'MN', 'KOR': 'KR', 'PRK': 'KP', 'RUS': 'RU',
            'SAU': 'SA', 'EGY': 'EG', 'GRC': 'GR', 'ETH': 'ET', 'THA': 'TH',
            'LAO': 'LA', 'KHM': 'KH', 'MMR': 'MM', 'BGD': 'BD', 'NPL': 'NP',
            'BTN': 'BT', 'PAK': 'PK', 'AFG': 'AF', 'IRN': 'IR', 'IRQ': 'IQ',
            'SYR': 'SY', 'ISR': 'IL', 'JOR': 'JO', 'LBN': 'LB', 'TUR': 'TR',
            'ARM': 'AM', 'GEO': 'GE', 'AZE': 'AZ', 'VNM': 'VN', 'PHL': 'PH',
            'MYS': 'MY', 'SGP': 'SG', 'BRN': 'BN', 'GBR': 'GB', 'DEU': 'DE',
            'FRA': 'FR', 'ITA': 'IT', 'ESP': 'ES', 'PRT': 'PT', 'NLD': 'NL',
            'SWE': 'SE', 'NOR': 'NO', 'FIN': 'FI', 'DNK': 'DK', 'ISL': 'IS',
            'CAN': 'CA', 'MEX': 'MX', 'BRA': 'BR', 'ARG': 'AR', 'CHL': 'CL',
            'COL': 'CO', 'PER': 'PE', 'VEN': 'VE', 'ZAF': 'ZA', 'NGA': 'NG',
            'KEN': 'KE', 'TZA': 'TZ', 'UGA': 'UG', 'MAR': 'MA', 'DZA': 'DZ',
            'TUN': 'TN', 'LBY': 'LY', 'SDN': 'SD', 'AUS': 'AU', 'NZL': 'NZ'
        };

        function convertIso3to2(iso3) {
            // Cek di map manual dulu, kalau tidak ada, coba ambil 2 huruf pertama (fallback)
            return ISO_MAP[iso3] || iso3.substring(0, 2).toUpperCase();
        }

        // --- 2. LOAD DATA DENGAN ERROR HANDLING ---
        async function loadData() {
            const statusEl = document.getElementById('statusArea');
            const lampEl = document.getElementById('connStatus');
            
            try {
                statusEl.innerText = "Mengunduh aksara.json...";
                
                // Tambahkan timestamp agar tidak kena cache browser saat update
                const response = await fetch('aksara.json?v=' + new Date().getTime());
                
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                GLOBAL_SCRIPT_DB = await response.json();
                
                console.log("Database Loaded:", Object.keys(GLOBAL_SCRIPT_DB.countries).length, "countries");
                statusEl.innerText = "Data Siap (Lokal)";
                lampEl.classList.add('ready');
            } catch (e) {
                console.error("Gagal load JSON:", e);
                statusEl.innerHTML = "<span style='color:red'>Gagal baca aksara.json!<br>Cek Console.</span>";
                lampEl.classList.add('error');
            }
        }

        // --- 3. FUNGSI UNTUK MEMPERBAIKI SAMPLE (Solusi \u0000) ---
        function getSafeSample(script) {
            // Jika sample ada dan BUKAN karakter kontrol (kode > 32)
            if (script.sample && script.sample.codePointAt(0) > 32) {
                return script.sample;
            }
            
            // Jika sample kosong atau invisible (\u0000), hitung dari range
            if (script.range) {
                try {
                    const parts = script.range.split('-');
                    if (parts.length === 2) {
                        const start = parseInt(parts[0], 16);
                        // Ambil karakter ke-5 dari awal range supaya biasanya bukan simbol aneh
                        return String.fromCodePoint(start + 4); 
                    }
                } catch (e) {
                    return "?";
                }
            }
            return "?";
        }

        // --- INIT MAP ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(); // Jalankan load data segera

            const map = L.map('map', { zoomControl: false, minZoom: 2 }).setView([20, 0], 2);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(res => res.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: { fillColor: '#E6DFD3', weight: 1, color: '#B0A99F', fillOpacity: 1 },
                        onEachFeature: (f, l) => {
                            l.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                const iso3 = f.id;
                                const iso2 = convertIso3to2(iso3);
                                console.log(`Clicked: ${f.properties.name} (${iso3} -> ${iso2})`);
                                openCountry(iso2, f.properties.name);
                            });
                        }
                    }).addTo(map);
                });
        });

        // --- UI LOGIC ---
        function openCountry(iso, name) {
            document.getElementById('countryName').innerText = name;
            document.getElementById('countryCode').innerText = iso;
            document.getElementById('infoPanel').classList.add('open');
            
            renderScripts(iso);
        }

        function renderScripts(iso) {
            const list = document.getElementById('scriptList');
            list.innerHTML = '';

            // Cek apakah data DB sudah siap
            if (!GLOBAL_SCRIPT_DB.countries) {
                list.innerHTML = '<div style="padding:20px; text-align:center; color:orange;">Data sedang dimuat...<br>Silakan tunggu & coba klik lagi.</div>';
                return;
            }

            const scriptIds = GLOBAL_SCRIPT_DB.countries[iso];
            
            if (!scriptIds || scriptIds.length === 0) {
                list.innerHTML = `<div style="padding:20px; text-align:center;">Tidak ada data aksara spesifik untuk kode <strong>${iso}</strong>.</div>`;
                return;
            }

            scriptIds.forEach(id => {
                const script = GLOBAL_SCRIPT_DB.definitions[id];
                if (!script) return;

                // Load Font Dinamis
                if (script.font && script.font !== 'null' && !loadedFonts.has(script.font)) {
                    const link = document.createElement('link');
                    link.href = `https://fonts.googleapis.com/css2?family=${script.font}&display=swap`;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                    loadedFonts.add(script.font);
                }

                const fontFamily = script.font ? script.font.replace(/\+/g, ' ') : 'sans-serif';
                // Gunakan fungsi safe sample di sini
                const displaySample = getSafeSample(script);
                const isUnicode = script.unicode === true || script.unicode === "TRUE";

                const div = document.createElement('div');
                div.className = 'script-card';
                div.innerHTML = `
                    <span class="script-name">${script.name_id || script.name_en}</span>
                    <div style="font-size:0.8rem; color:#666;">Range: ${script.range}</div>
                    
                    <div class="script-sample" style="font-family:'${fontFamily}';">
                        ${displaySample}
                    </div>
                    
                    <div class="meta-row">
                        <a href="https://fonts.google.com/specimen/${script.font || ''}" target="_blank" class="btn btn-primary">Unduh Font</a>
                        <button class="btn" onclick="alert('Fitur Grid akan hadir segera!')">Lihat Grid</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function enterApp() {
            document.getElementById('landing-page').classList.add('hidden');
            setTimeout(() => document.getElementById('landing-page').style.display = 'none', 800);
        }
        function closePanel() { document.getElementById('infoPanel').classList.remove('open'); }
    </script>
</body>
</html>
